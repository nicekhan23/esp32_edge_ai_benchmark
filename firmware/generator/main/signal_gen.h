/**
 * @file signal_gen.h
 * @brief Signal Generator Header File
 * @details This file defines the interface for the ESP32-based signal generator.
 * It provides waveform types, configuration structure, and function prototypes
 * for controlling the signal generation system.
 * 
 * @author Darkhan Zhanibekuly
 * @date 2025 December
 * @version 1.0.0
 * 
 * @copyright (c) 2025 December ESP32 Signal Generator Project
 */

#pragma once

#include <stdint.h>
#include <stdbool.h>

/**
 * @brief Enumeration of available waveform types
 * 
 * This enumeration defines the four basic waveform types that can be
 * generated by the signal generator. Each waveform has unique harmonic
 * characteristics suitable for different testing scenarios.
 */
typedef enum {
    SIGNAL_WAVE_SINE = 0,       /**< Sine wave - pure tone with single frequency */
    SIGNAL_WAVE_SQUARE,         /**< Square wave - 50% duty cycle digital waveform */
    SIGNAL_WAVE_TRIANGLE,       /**< Triangle wave - linear rise and fall */
    SIGNAL_WAVE_SAWTOOTH,       /**< Sawtooth wave - linear rise with abrupt fall */
} signal_wave_t;

/**
 * @brief Signal generator configuration structure
 * 
 * This structure contains all configurable parameters for the signal generator.
 * It controls the waveform characteristics, amplitude, frequency, and other
 * signal properties.
 */
typedef struct {
    signal_wave_t wave;         /**< Waveform type (sine, square, triangle, sawtooth) */
    float amplitude;            /**< Signal amplitude in range [0.0, 1.0] (normalized) */
    float noise_std;            /**< Gaussian noise standard deviation (0.0 = no noise) */
    float dc_offset;            /**< DC offset in range [-1.0, +1.0] (normalized) */
    uint32_t frequency_hz;      /**< Signal frequency in Hertz (Hz) */
    uint32_t duration_ms;       /**< Duration in milliseconds (0 = continuous) */
} signal_gen_config_t;

/* ========== Lifecycle Management Functions ========== */

/**
 * @brief Initialize the signal generator hardware
 * 
 * This function initializes the DAC hardware, allocates necessary buffers,
 * and sets up the initial waveform configuration. It must be called before
 * any other signal generator functions.
 * 
 * @note This function configures DAC channel 0 (GPIO25) by default.
 */
void signal_gen_init(void);

/**
 * @brief Start signal generation
 * 
 * Begins outputting the configured waveform through the DAC. If a duration
 * is specified in the configuration, the signal will automatically stop
 * after that time period.
 * 
 * @pre signal_gen_init() must be called first
 * @warning If duration_ms > 0, this function will block for the specified duration
 */
void signal_gen_start(void);

/**
 * @brief Stop signal generation
 * 
 * Immediately halts DAC output and stops signal generation. The waveform
 * buffer is preserved for when generation restarts.
 */
void signal_gen_stop(void);

/* ========== Configuration Management Functions ========== */

/**
 * @brief Update signal generator configuration
 * 
 * Applies a new configuration to the signal generator. If signal generation
 * is currently active, the new waveform will begin outputting immediately.
 * 
 * @param[in] cfg Pointer to new configuration structure
 * 
 * @note This function resets the phase accumulator to ensure waveform continuity
 */
void signal_gen_set_config(const signal_gen_config_t *cfg);

/**
 * @brief Validate signal generator configuration
 * 
 * Checks the provided configuration structure for valid parameter ranges.
 * Returns true if all parameters are valid, false otherwise.
 * 
 * @param[in] cfg Pointer to configuration structure to validate
 * @return true if configuration is valid, false otherwise
 */
bool validate_config(const signal_gen_config_t *cfg);

/**
 * @brief Get current signal generator configuration
 * 
 * Returns a pointer to the current configuration structure. This can be used
 * to read current settings or as a starting point for modifications.
 * 
 * @return Pointer to current configuration (read-only)
 */
const signal_gen_config_t *signal_gen_get_config(void);

/* ========== Metadata and Labeling Functions ========== */

/**
 * @brief Emit configuration label to console
 * 
 * Outputs the current configuration in a standardized LABEL format that
 * can be parsed by external tools. This is useful for logging and
 * synchronization with measurement equipment.
 * 
 * Format: "LABEL wave=%d amp=%.2f freq=%lu noise=%.3f offset=%.2f"
 */
void signal_gen_emit_label(void);

/**
 * @brief Broadcast configuration label via UART
 * 
 * Sends current configuration in machine-readable format for synchronization
 * with acquisition device.
 */
void signal_gen_broadcast_label(void);